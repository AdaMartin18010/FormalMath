# 单子 (Monad)

**创建日期**: 2025年12月11日
**来源**: Category Theory Using Haskell, Chapter 6
**主题编号**: CT.YUKITA.01.04

---

## 📑 目录

- [单子 (Monad)](#单子-monad)
  - [📑 目录](#-目录)
  - [一、单子的定义](#一单子的定义)
    - [1.1 单子的数学定义](#11-单子的数学定义)
    - [1.2 Kleisli三元组](#12-kleisli三元组)
  - [二、Haskell中的单子](#二haskell中的单子)
    - [2.1 Monad类型类](#21-monad类型类)
    - [2.2 单子定律](#22-单子定律)
    - [2.3 单子的其他操作](#23-单子的其他操作)
  - [三、单子的例子](#三单子的例子)
    - [3.1 Maybe单子](#31-maybe单子)
    - [3.2 List单子](#32-list单子)
    - [3.3 IO单子](#33-io单子)
  - [四、单子与伴随](#四单子与伴随)
    - [4.1 从伴随到单子](#41-从伴随到单子)
    - [4.2 从单子到伴随](#42-从单子到伴随)

---

## 一、单子的定义

### 1.1 单子的数学定义

**单子 (Monad)** 在范畴 $\mathcal{C}$ 上由以下数据组成：

1. **函子**: $T: \mathcal{C} \to \mathcal{C}$
2. **单位自然变换**: $\eta: 1_{\mathcal{C}} \Rightarrow T$
3. **乘法自然变换**: $\mu: T \circ T \Rightarrow T$

**满足的条件**：

1. **左单位律**: $\mu \circ (T \eta) = 1_T$
2. **右单位律**: $\mu \circ (\eta T) = 1_T$
3. **结合律**: $\mu \circ (T \mu) = \mu \circ (\mu T)$

**交换图**：
$$
\begin{CD}
T \circ T \circ T @>{T\mu}>> T \circ T \\
@V{\mu T}VV @VV{\mu}V \\
T \circ T @>>{\mu}> T
\end{CD}
$$

### 1.2 Kleisli三元组

**Kleisli三元组** $(T, \eta, \star)$ 等价于单子：

- **函子**: $T: \mathcal{C} \to \mathcal{C}$
- **单位**: $\eta_A: A \to T(A)$
- **Kleisli扩展**: $f: A \to T(B)$ 映射到 $f^\star: T(A) \to T(B)$

**关系**：

- $\mu_A = (1_{T(A)})^\star$
- $f^\star = \mu_B \circ T(f)$

---

## 二、Haskell中的单子

### 2.1 Monad类型类

**Monad类型类**定义：

```haskell
class Functor m => Monad m where
    return :: a -> m a
    (>>=) :: m a -> (a -> m b) -> m b
```

**数学对应**：

- `Monad m` 对应单子 $(T, \eta, \mu)$
- `return` 对应单位自然变换 $\eta$
- `(>>=)` 对应Kleisli扩展 $\star$

### 2.2 单子定律

**Monad必须满足的定律**：

1. **左单位律**: `return x >>= f = f x`
   - 数学表示：$\mu_A \circ T(\eta_A) = 1_{T(A)}$

2. **右单位律**: `m >>= return = m`
   - 数学表示：$\mu_A \circ \eta_{T(A)} = 1_{T(A)}$

3. **结合律**: `(m >>= f) >>= g = m >>= (\x -> f x >>= g)`
   - 数学表示：$\mu \circ (T \mu) = \mu \circ (\mu T)$

**证明思路**：

- 左单位律：$(f \star \circ \eta_A)(a) = f^\star(\eta_A(a)) = f(a)$
- 右单位律：$(\eta_A^\star)(m) = \mu_A(T(\eta_A)(m)) = m$
- 结合律：使用自然变换的结合律

### 2.3 单子的其他操作

**单子的其他操作**：

```haskell
-- fmap可以用>>=定义
fmap f m = m >>= (return . f)

-- join可以用>>=定义
join :: Monad m => m (m a) -> m a
join m = m >>= id

-- 数学对应：join对应乘法自然变换μ
```

**数学关系**：

- `fmap` 对应 $T(f)$
- `join` 对应 $\mu_A: T(T(A)) \to T(A)$
- `(>>=)` 对应Kleisli扩展

---

## 三、单子的例子

### 3.1 Maybe单子

**Maybe单子**表示可能失败的计算：

```haskell
instance Monad Maybe where
    return x = Just x
    Nothing >>= f = Nothing
    Just x >>= f = f x
```

**数学解释**：

- `Maybe` 对应函子 $T: \mathbf{Hask} \to \mathbf{Hask}$
- `return` 对应 $\eta_A: A \to \text{Maybe}(A)$
- `(>>=)` 对应Kleisli扩展

**应用**：

- 错误处理
- 可选值计算
- 可能失败的操作链

### 3.2 List单子

**List单子**表示非确定性计算：

```haskell
instance Monad [] where
    return x = [x]
    xs >>= f = concat (fmap f xs)
```

**数学解释**：

- `[]` 对应函子 $T: \mathbf{Hask} \to \mathbf{Hask}$
- `return` 将值包装成单元素列表
- `(>>=)` 对应列表的"展平"操作

**应用**：

- 非确定性计算
- 列表推导式
- 搜索问题

### 3.3 IO单子

**IO单子**表示输入输出操作：

```haskell
instance Monad IO where
    return x = returnIO x
    m >>= f = bindIO m f
```

**数学解释**：

- `IO` 对应函子 $T: \mathbf{Hask} \to \mathbf{Hask}$
- `return` 创建纯值
- `(>>=)` 顺序执行IO操作

**应用**：

- 副作用处理
- 输入输出操作
- 状态管理

---

## 四、单子与伴随

### 4.1 从伴随到单子

**伴随函子产生单子**：

给定伴随对 $F \dashv G: \mathcal{C} \to \mathcal{D}$，可以构造单子 $T = G \circ F$。

**构造**：

- **函子**: $T = G \circ F$
- **单位**: $\eta: 1_{\mathcal{C}} \Rightarrow T$（伴随的单位）
- **乘法**: $\mu = G(\epsilon_F): T \circ T \Rightarrow T$（伴随的余单位）

**数学证明**：

- 单子定律由伴随的三角恒等式保证

### 4.2 从单子到伴随

**单子产生伴随**：

给定单子 $(T, \eta, \mu)$，可以构造Kleisli伴随 $F_T \dashv G_T$。

**构造**：

- **Kleisli范畴**: $\mathcal{C}_T$ 的对象与 $\mathcal{C}$ 相同，映射 $A \to B$ 对应 $\mathcal{C}$ 中的映射 $A \to T(B)$
- **函子**: $F_T: \mathcal{C} \to \mathcal{C}_T$，$G_T: \mathcal{C}_T \to \mathcal{C}$
- **伴随**: $F_T \dashv G_T$

**Haskell对应**：

- Kleisli范畴对应Haskell中的单子计算
- `(>>=)` 对应Kleisli范畴中的复合

---

**最后更新**: 2025年12月11日
**参考章节**: Chapter 6
